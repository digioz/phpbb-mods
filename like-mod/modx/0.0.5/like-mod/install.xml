<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.3.xsd">
	<header>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25"/>
	</header>
	<action-group>
		<copy>
			<file from="root/likedlist.php" to="likedlist.php"/>
			<file from="root/styles/prosilver/template/likedlist_body.html" to="styles/prosilver/template/likedlist_body.html"/>
			<file from="root/styles/prosilver/theme/mods.css" to="styles/prosilver/theme/mods.css"/>
			<file from="root/styles/prosilver/theme/images/thumbs_up2_22x20.jpg" to="styles/prosilver/theme/images/thumbs_up2_22x20.jpg"/>
		</copy>
		<open src="posting.php">
			<edit>
				<find><![CDATA[			return;
		}]]></find>
				<action type="after-add"><![CDATA[	break;

	case 'like':
		  if ($user->data['username'] != "Anonymous")
		  {
			submit_like($forum_id, $topic_id, $user->data['user_id'], $user->data['username']);
		  }
		 
		  redirect(append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id"));]]></action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[	'U_POST_REPLY_TOPIC' 	=> ($auth->acl_get('f_reply', $forum_id) || $user->data['user_id'] == ANONYMOUS) ? append_sid("{$phpbb_root_path}posting.$phpEx", "mode=reply&amp;f=$forum_id&amp;t=$topic_id") : '',]]></find>
				<action type="after-add"><![CDATA[	'U_LIKE_TOPIC'          => ($phpbb_root_path."posting.".$phpEx."?mode=like&amp;f=".$forum_id."&amp;t=".$topic_id), 'U_LIKE_USERS_LIST'     => (get_like_list($forum_id, $topic_id)), ]]></action>
			</edit>
		</open>
		<open src="includes/functions_display.php">
			<edit>
				<find><![CDATA[	return '<img src="' . (str_replace(' ', '%20', $avatar_img)) . '" width="' . $avatar_width . '" height="' . $avatar_height . '" alt="' . ((!empty($user->lang[$alt])) ? $user->lang[$alt] : $alt) . '" />';
}]]></find>
				<action type="after-add"><![CDATA[
    function get_like_list($forum_id, $topic_id)
    {
        global $db, $config;
        $like_list = '';
               
        $sql = "SELECT A.user_id, A.username, B.user_colour FROM phpbb_likes AS A, phpbb_users AS B
                WHERE forum_id=$forum_id AND topic_id=$topic_id AND A.user_id = B.user_id
                ORDER BY username ASC;";

        $result = $db->sql_query($sql);
       
        $result_set = $db->sql_fetchrowset($result);
       
        for($i = 0; $i < sizeof($result_set); $i++)
        {
            $like_list .= "<a href=\"memberlist.php?mode=viewprofile&u=".$result_set[$i]['user_id']."\">
            <font color=\"".$result_set[$i]['user_colour']."\">".$result_set[$i]['username']."</font></a>";
           
            if ($i < sizeof($result_set) - 1)
            {
                $like_list .= ", ";   
            }
        }

        return $like_list;   
    }
	
    function get_liked_list($start = 0, $end = false)
    {
        global $db, $config, $auth;
       
        $ex_fid_ary = array_keys($auth->acl_getf('!f_read', true));
       
        $sql = "SELECT A.topic_id,
                    COUNT(A.topic_id) as count,
                    B.forum_id,
                    B.topic_type,
                    B.topic_replies_real,
                    B.topic_replies,
                    B.topic_status,
                    B.topic_moved_id,
                    B.topic_last_post_time,
                    B.topic_approved,
                    B.topic_poster,
                    B.topic_first_poster_name,
                    B.topic_time,
                    B.topic_last_post_subject,
                    B.topic_last_post_time,
                    B.topic_last_poster_id,
                    B.topic_views,
                    B.topic_title,
                    B.icon_id,
                    B.topic_attachment,
                    B.topic_first_poster_name,
                    B.topic_last_post_id,
                    B.topic_last_poster_id,
                    B.topic_last_poster_name,
                    B.topic_last_poster_colour,
                    B.topic_last_post_subject,
                    B.topic_last_post_time,
                    B.topic_last_view_time
                FROM phpbb_likes as A, phpbb_topics AS B WHERE A.topic_id=B.topic_id ".           
                ((sizeof($ex_fid_ary)) ? ' AND ' . $db->sql_in_set('B.forum_id', $ex_fid_ary, true) : '') .
                "GROUP BY A.topic_id ORDER BY count DESC LIMIT 50;";
               
        /*if(!($result = $db->sql_query_limit($sql, $end, $start)))
        {
            message_die(GENERAL_ERROR, 'Error retrieving search results', '', __LINE__, __FILE__, $sql);
        }*/
       
        $result = $db->sql_query($sql);
       
        $result_set = $db->sql_fetchrowset($result);

        return $result_set;   
    }]]></action>
			</edit>
		</open>
		<open src="includes/functions_posting.php">
			<edit>
				<find><![CDATA[	return $url;
}]]></find>
				<action type="after-add"><![CDATA[
    function get_like_exists($forum_id = 0, $topic_id = 0, $username)
    {
        global $db, $config;
        $return_value = false;
               
        $sql = "SELECT COUNT(like_id) AS like_id_count FROM phpbb_likes
                WHERE forum_id=$forum_id AND topic_id=$topic_id
                AND username='$username';";

        $result = $db->sql_query($sql);
        $like_count = (int) $db->sql_fetchfield('like_id_count', false, $result);

        if ($like_count > 0)
        {
            $return_value = true;
        }

        return $return_value; 
    }

    function submit_like($forum_id, $topic_id, $user_id, $username)
    {
        if (get_like_exists($forum_id, $topic_id, $username) != true)
        {
            global $db, $config;
            $uid = (int)$user_id;

            $data = array(
                'forum_id'  => $forum_id,
                'topic_id'  => $topic_id,
                'user_id'   => $uid,
                'username'  => $username
            );
           
            $sql = "INSERT INTO phpbb_likes ".$db->sql_build_array('INSERT', $data);
            $db->sql_query($sql);
        }
    }]]></action>
			</edit>
		</open>
		<open src="language/en/common.php">
			<edit>
				<find><![CDATA[	'SEARCH_UNREAD'				=> 'View unread posts',]]></find>
				<action type="after-add"><![CDATA[	'MOST_LIKED_TOPICS'         => 'Most Liked Topics',]]></action>
			</edit>
		</open>
		<open src="language/en/viewtopic.php">
			<edit>
				<find><![CDATA[	'VOTE_CONVERTED'		=> 'Changing votes is not supported for converted polls.',]]></find>
				<action type="after-add"><![CDATA[	'LIKE_TEXT'            => 'like(s) this thread.',]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/index_body.html">
			<edit>
				<find><![CDATA[		<li><a href="{U_SEARCH_UNANSWERED}">{L_SEARCH_UNANSWERED}</a><!-- IF S_LOAD_UNREADS --> &bull; <a href="{U_SEARCH_UNREAD}">{L_SEARCH_UNREAD}</a><!-- ENDIF --><!-- IF S_USER_LOGGED_IN --> &bull; <a href="{U_SEARCH_NEW}">{L_SEARCH_NEW}</a><!-- ENDIF --> &bull; <a href="{U_SEARCH_ACTIVE_TOPICS}">{L_SEARCH_ACTIVE_TOPICS}</a></li>]]></find>
				<inline-edit>
					<inline-find><![CDATA[		<li><a href="{U_SEARCH_UNANSWERED}">{L_SEARCH_UNANSWERED}</a><!-- IF S_LOAD_UNREADS --> &bull; <a href="{U_SEARCH_UNREAD}">{L_SEARCH_UNREAD}</a><!-- ENDIF --><!-- IF S_USER_LOGGED_IN --> &bull; <a href="{U_SEARCH_NEW}">{L_SEARCH_NEW}</a><!-- ENDIF --> &bull; <a href="{U_SEARCH_ACTIVE_TOPICS}">{L_SEARCH_ACTIVE_TOPICS}</a>]]></inline-find>
					<inline-action type="after-add"><![CDATA[ &bull;]]></inline-action>
				</inline-edit>
				<action type="after-add"><![CDATA[		<li><a href="likedlist.php">{L_MOST_LIKED_TOPICS}</a></li>]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/overall_header.html">
			<edit>
				<find><![CDATA[	<link href="{T_THEME_PATH}/bidi.css" rel="stylesheet" type="text/css" media="screen, projection" />
<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[
<link href="{T_THEME_PATH}/mods.css" rel="stylesheet" type="text/css" />]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[			</form>
		</div>
	<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[	<div class="search-box" valign="bottom">
          <form method="post" id="like-button" action="{U_LIKE_TOPIC}">
                <input class="buttonlike" type="submit" value="" />
          </form>
    </div>]]></action>
			</edit>
			<edit>
				<find><![CDATA[	<!-- ENDIF -->

</div>]]></find>
				<action type="after-add"><![CDATA[    <!-- IF U_LIKE_USERS_LIST -->
    <div class="panel">
        <div class="inner">
            <span class="corners-top"><span></span></span>   
            <div style="width:100%">       
                {U_LIKE_USERS_LIST} {L_LIKE_TEXT}
            </div>
            <span class="corners-bottom"><span></span></span>
        </div>
    </div>
    <!-- ENDIF -->
]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/theme/content.css">
			<edit>
				<find><![CDATA[dd.posts, dd.topics, dd.views {]]></find>
				<inline-edit>
					<inline-find><![CDATA[dd.posts, dd.topics, dd.views]]></inline-find>
					<inline-action type="after-add"><![CDATA[, dd.likes]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[	width: 8%;]]></find>
				<inline-edit>
					<inline-find><![CDATA[	width: ]]></inline-find>
					<inline-find><![CDATA[8%]]></inline-find>
					<inline-action type="replace-with"><![CDATA[5%]]></inline-action>
				</inline-edit>
			</edit>
		</open>
	</action-group>
</mod>
